<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="author" content="Lea Kleesattel">
    <meta name="description" content="Marche Webinterface">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,
        minimum-scale=1.0">
    <title>Marche Webinterface</title>
    <link href="favicon.ico/logo-new.svg" rel="shortcut icon">
    <link rel="stylesheet" href="static/style.css">
    <link rel="stylesheet" href="static/material.min.css">
    <link rel="stylesheet" href="static/material-icons.css">
    <script src="static/material.min.js"></script>
    <script src="static/jquery-3.2.1.min.js"></script>
    <script type="text/javascript">
        function colorStatus(service) {
            switch (service.text()) {
                case "RUNNING":
                    service.css('color', 'rgb(0, 128, 0)');
                    break;
                case "DEAD":
                    service.css('color', 'rgb(255, 0, 0)');
                    break;
                default:
                    service.css('color', 'rgb(0, 0, 255)');
            }
        }

        function ctlButtonAppearance(service) {
            switch ($("#" + service + "_status").css("color")) {
                case "rgb(255, 0, 0)":
                    $("#start_" + service).show();
                    $("#stop_" + service).hide();
                    break;
                case "rgb(0, 0, 255)":
                    $("#start_" + service).show();
                    $("#stop_" + service).hide();
                    break;
                case "rgb(0, 128, 0)":
                    $("#start_" + service).hide();
                    $("#stop_" + service).show();
                    break;
                default:
                    console.log("Unknown color");
            }
        }

        function triggerStatus() {
            $.get("get_status", function (data) {
                for (var service in {{ svc_sts }}) {
                    var idStatus = $("#" + service + "_status");
                    idStatus.text(data[service]);
                    colorStatus(idStatus);
                    ctlButtonAppearance(service);
                }
            }, "json");
        }

        function setHostname() {
            $.get("get_hostname", function (hostname) {
                $("#titleHostname").text("Marche Webinterface: " + hostname);
            }, "json");
        }

        $(document).ready(function() {
            setInterval(triggerStatus, 3000);
            setHostname();
            for (var service in {{ svc_sts }}) {
                var idStatus = $("#" + service + "_status");
                colorStatus(idStatus);
                ctlButtonAppearance(service);
            }

            $("button").click(function(){
                const data = $.parseJSON($(this).attr("data-button"));
                const form = $("#buttonForm"), url = form.attr("action"),
                    id = this.id;
                if(id.startsWith('start_'))
                    $.post(url, {startButton: data.startButton});
                else if (id.startsWith('stop_'))
                    $.post(url, {stopButton: data.stopButton});
                else if (id.startsWith('restart_'))
                    $.post(url, {restartButton: data.restartButton});
                triggerStatus();
            });

            if({{ logged_in }}) {
                $("#login_logout_link").attr("href", "logout");
                $("#login_logout").text("Logout");
                for (var service in {{ svc_sts }}) {
                    $("#start_" + service).attr('disabled',false);
                    $("#stop_" + service).attr('disabled',false);
                    $("#restart_" + service).attr('disabled',false);
                }
            }
        });
    </script>
</head>
<body>
{# navbar #}
<div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
<header class="mdl-layout__header mdl-shadow--16dp">
    <div class="mdl-layout__header-row">
        <span class="mdl-layout-title" id="titleHostname"></span>
        <div class="mdl-layout-spacer"></div>
        <nav class="mdl-navigation mdl-layout__header--waterfall">
            <ul>
                <a href="login" id="login_logout_link">
                <button class="mdl-button mdl-js-button mdl-js-ripple-effect"
                    title="Login" id="btnNav" type="submit"
                    data-button='{"buttonNav": "buttonClicked"}'>
                    <div id="login_logout">Login</div>
                </button>
                </a>
            </ul>
        </nav>
    </div>
</header>
<div class="mdl-layout__drawer">
    <span class="mdl-layout-title">
        <a class="mdl-navigation__link" href="index" id="index">
            <img src="favicon.ico/logo-new.svg"></a>
    </span>
    <nav class="mdl-navigation mdl-layout__header--waterfall">
        <ul><a class="mdl-navigation__link" href="index">Control</a></ul>
        <ul><a class="mdl-navigation__link" href="help">Help</a></ul>
    </nav>
</div>
{# main content #}
<main class="mdl-layout__content">
    <div class="page-content">
        <div class="mdl-grid mdl-grid-center">
            {% block content %}{% endblock %}
        </div>
    </div>
</main>
</div>
</body>
</html>
